schedules:
- cron: "0 8 * * *"   # 05h BRT
  displayName: "Rodar diariamente Ã s 05h (BRT)"
  branches:
    include:
    - master
  always: true

- cron: "0 9 * * *"   # 06h BRT
  displayName: "Rodar diariamente Ã s 06h (BRT)"
  branches:
    include:
    - master
  always: true

trigger:
  - master

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Instalar Node.js'

  - script: |
      npm ci
    displayName: 'Instalar dependÃªncias (npm ci)'

  - script: |
      npm audit --audit-level=moderate || true
    displayName: 'Executar auditoria de seguranÃ§a'
    continueOnError: true

  - script: |
      echo "ğŸ”¥ Limpando relatÃ³rios anteriores"
      npx rimraf cypress/reports/mochawesome-report/*
      npx rimraf cypress/reports/allure-results/*
    displayName: 'Limpar relatÃ³rios anteriores'

  - script: |
      echo "ğŸš€ Executando testes smoke"
      npm run test
    displayName: 'Executar testes Cypress'
    continueOnError: true

  - script: |
      echo "ğŸ“¦ Mesclando relatÃ³rios JSON"
      npx mochawesome-merge cypress/reports/mochawesome-report/*.json > cypress/reports/mochawesome-report/report.json
    displayName: 'Mesclar relatÃ³rios JSON'
    condition: always()

  - script: |
      echo "ğŸ“Š Gerando HTML do Mochawesome"
      npx marge cypress/reports/mochawesome-report/report.json --reportDir=cypress/reports/mochawesome-report --inline
    displayName: 'Gerar relatÃ³rio HTML Mochawesome'
    condition: always()

  - script: |
      echo "ğŸ¯ Gerando relatÃ³rio Allure"
      npx allure generate cypress/reports/allure-results --clean -o cypress/reports/allure-report || true
    displayName: 'Gerar relatÃ³rio Allure'
    condition: always()
    continueOnError: true


  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'cypress/reports/allure-report'
      artifact: 'allure-report'
      publishLocation: 'pipeline'
    displayName: 'ğŸ“¤ Publicar Allure como artefato'
    condition: always()
    continueOnError: true

  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'cypress/screenshots'
      artifact: 'screenshots-failure'
      publishLocation: 'pipeline'
    displayName: 'ğŸ“¸ Publicar screenshots de falhas'
    condition: failed()
    continueOnError: true
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: 'cypress/reports/mochawesome-report'
      artifact: 'mochawesome-report'
      publishLocation: 'pipeline'
    displayName: 'ğŸ“¤ Publicar Mochawesome como artefato'
    condition: always()

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/test-results-*.xml'
      testResultsFormat: 'JUnit'
      mergeTestResults: true
      failTaskOnFailedTests: false
    displayName: 'ğŸ“Š Publicar resultados de teste no Azure DevOps'
    condition: always()

  - script: |
      curl -H "Content-Type: application/json" \
          -d "{\"text\": \"âŒ The pipeline has failed! Check the logs here: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)\"}" \
          https://acspcombr.webhook.office.com/webhookb2/CODES_Here
    displayName: 'ğŸ”” Notificar Teams'
    condition: or(failed(), eq(variables['Agent.JobStatus'], 'SucceededWithIssues'))

